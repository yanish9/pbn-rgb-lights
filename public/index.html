<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Groups & Color Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="css/boot.css" rel="stylesheet"  />

  <style>
    body {
      background: radial-gradient(1200px 800px at 20% 0%, #0b1224 0%, #0f172a 40%, #0a0f1f 100%);
      color: #e5e7eb;
    }
    .shell {
      max-width: 1100px;
      margin: 24px auto;
      background: rgba(17, 24, 39, 0.65);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 0 0 1px rgba(255,255,255,0.02);
      position: relative;
    }

    .logo { max-width: 160px; filter: drop-shadow(0 6px 14px rgba(0,0,0,0.35)); }
    .panel {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 16px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
    }

     .refresh-btn {
      position: absolute;
      top: 16px;
      right: 16px;
    }

    .btn-custom {
      border: 1px solid #475569;           /* slate-600 */
      border-radius: 12px;
      min-width: 48px;
      height: 44px;
      color: #e5e7eb;
      background: linear-gradient(180deg, #0b1224 0%, #111827 100%);
      box-shadow: 0 1px 0 rgba(255,255,255,0.05), 0 8px 20px rgba(0,0,0,0.25);
      transition: transform .12s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .btn-custom:hover { border-color: #64748b; }
    .btn-custom:active { transform: translateY(1px); }

    /* ðŸ”¥ Stronger highlight */
    .btn-selected {
      border: 3px solid #fcfeff !important;   /* cyan-400 */
      box-shadow: 0 0 7px rgba(56,189,248,0.9), 0 0 7px rgba(56,189,248,0.6) !important;
      transform: scale(1.05);
      z-index: 2;
      position: relative;
    }

    .palette {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .swatch {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.35);
      cursor: pointer;
      transition: transform .06s ease, outline .2s ease, box-shadow .2s ease;
    }
    .swatch:hover { transform: translateY(-1px); }
    .swatch-selected {
      outline: 3px solid #fff;
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(11, 18, 36, 0.7);
      border: 1px solid rgba(255,255,255,0.06);
      color: #cbd5e1;
      font-size: 13px;
    }
    .swatch-mini {
      width: 16px;
      height: 16px;
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.35);
    }
    .all-btn { border-radius: 12px; }
    h5 { color: #cbd5e1; margin: 0; font-weight: 600; }
  </style>
</head>
<body>
  <div class="shell">
     <button class="btn btn-outline-light refresh-btn" onclick="hardRefresh()">âŸ³ Refresh</button>

    <div class="d-flex justify-content-center align-items-center mb-3">
      <img src="/img/itarget.png" alt="iTarget" class="logo">
    </div>
    <p class="text-center text-secondary-emphasis mb-4" style="color:#cbd5e1 !important">RGB Lights</p>

    <div class="row g-3">
      <!-- LEFT COLUMN -->
      <div class="col-md-6">
        <!-- Group 1 -->
        <div class="panel" data-group="1">
          <div class="group-head">
            <h5>Group 1 (7)</h5>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2" id="group1"></div>
          <button class="btn btn-primary w-100 py-2 all-btn" data-id="all" data-group="1">All</button>
        </div>

        <!-- Group 3 -->
        <div class="panel mt-3" data-group="3">
          <div class="group-head">
            <h5>Group 3 (2)</h5>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2" id="group3"></div>
          <button class="btn btn-primary w-100 py-2 all-btn" data-id="all" data-group="3">All</button>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-md-6">
        <!-- Group 2 -->
        <div class="panel" data-group="2">
          <div class="group-head">
            <h5>Group 2 (7)</h5>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2" id="group2"></div>
          <button class="btn btn-primary w-100 py-2 all-btn" data-id="all" data-group="2">All</button>
        </div>

        <!-- Group 4 -->
        <div class="panel mt-3" data-group="4">
          <div class="group-head">
            <h5>Group 4 (2)</h5>
          </div>
          <div class="d-flex gap-2 flex-wrap mb-2" id="group4"></div>
          <button class="btn btn-primary w-100 py-2 all-btn" data-id="all" data-group="4">All</button>
        </div>
      </div>
    </div>

    <div class="panel mt-4">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h5 class="m-0">Pick a Color</h5>
        <span class="status-pill">
          <span class="swatch-mini" id="miniSwatch" style="background: rgb(0,0,255)"></span>
          <span id="status">Waitingâ€¦</span>
        </span>
      </div>
      <div class="palette" id="palette"></div>
    </div>
  </div>

  <script>
    // Groups: per-group button IDs start at 1
    const groups = {
      1: { containerId: "group1", ids: [1,2,3,4,5,6] },
      2: { containerId: "group2", ids: [6,5,4,3,2,1] },
      3: { containerId: "group3", ids: [1,2] },
      4: { containerId: "group4", ids: [2,1] },
    };

    // Fixed palette
    const colors = [
      { name: "Red",     rgb: "255,0,0"   },
      { name: "Green",   rgb: "0,255,0"   },
      { name: "Blue",    rgb: "0,0,255"   },
      { name: "Yellow",  rgb: "255,255,0" },
      { name: "Cyan",    rgb: "0,255,255" },
      { name: "Magenta", rgb: "255,0,255" },
      { name: "Orange",  rgb: "255,165,0" },
      { name: "White",   rgb: "255,255,255" },
      { name: "Black",   rgb: "0,0,0" }
    ];

    // Build number buttons
    Object.entries(groups).forEach(([groupNum, cfg]) => {
      const el = document.getElementById(cfg.containerId);
      cfg.ids.forEach((id) => {
        const b = document.createElement("button");
        b.className = "btn btn-outline-secondary btn-custom btn-selectable";
        b.textContent = id;
        b.dataset.id = id;
        b.dataset.group = groupNum;
        el.appendChild(b);
      });
    });

    // Build palette
    const palette = document.getElementById("palette");
    colors.forEach(c => {
      const div = document.createElement("div");
      div.className = "swatch";
      div.style.background = `rgb(${c.rgb})`;
      div.dataset.rgb = c.rgb;
      div.title = c.name;
      palette.appendChild(div);
    });

    // Selection state
    let selectedTarget = null; // { group: number, id: string }
    let selectedColor = colors[2].rgb; // default Blue
    // show default color highlight
    setTimeout(() => {
      const defaultSwatch = [...document.querySelectorAll(".swatch")]
        .find(s => s.dataset.rgb === selectedColor);
      if (defaultSwatch) defaultSwatch.classList.add("swatch-selected");
      document.getElementById("miniSwatch").style.background = `rgb(${selectedColor})`;
      document.getElementById("status").textContent = "Pick a button, then a color";
    });

      function hardRefresh() {
    // Add a timestamp to bypass cache
    window.location.href = window.location.pathname + '?t=' + new Date().getTime();
  }

    // Helper: set selected button highlight
    function setSelectedButton(btnEl) {
      document.querySelectorAll(".btn-selectable, .all-btn").forEach(b => b.classList.remove("btn-selected"));
      if (btnEl) btnEl.classList.add("btn-selected");
    }

    // Handle button clicks (numbers + All)
    document.body.addEventListener("click", (e) => {
      const t = e.target;
      // All buttons
      if (t.classList.contains("all-btn")) {
        selectedTarget = { group: Number(t.dataset.group), id: "all" };
        setSelectedButton(t);
        document.getElementById("status").textContent = `Selected: Group ${selectedTarget.group}, All`;
        return;
      }
      // Numbered buttons
      if (t.classList.contains("btn-selectable") && t.dataset.group && t.dataset.id) {
        selectedTarget = { group: Number(t.dataset.group), id: String(t.dataset.id) };
        setSelectedButton(t);
        document.getElementById("status").textContent = `Selected: Group ${selectedTarget.group}, ID ${selectedTarget.id}`;
      }
    });

    // Handle palette click -> only sends if a button is selected
    palette.addEventListener("click", async (e) => {
      if (!e.target.classList.contains("swatch")) return;

      if (!selectedTarget) {
        alert("Select a button first (including 'All').");
        return;
      }

      // Update selected color highlight
      document.querySelectorAll(".swatch").forEach(s => s.classList.remove("swatch-selected"));
      e.target.classList.add("swatch-selected");
      selectedColor = e.target.dataset.rgb;
      document.getElementById("miniSwatch").style.background = `rgb(${selectedColor})`;

      const payload = { group: selectedTarget.group, id: selectedTarget.id, color: selectedColor };
      document.getElementById("status").textContent = `Sending`;

      try {
        const res = await fetch("/api/color", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error("HTTP " + res.status);

        console.log("Sent:", payload);
        document.getElementById("status").textContent = `Sent: Group ${payload.group}, ID ${payload.id}, Color rgb(${payload.color})`;
        // (Optional) clear selection after send:
        // selectedTarget = null; setSelectedButton(null);
      } catch (err) {
        console.error("Send failed:", err);
        alert("Failed to send color. See console.");
        document.getElementById("status").textContent = "Error sending payload";
      }
    });
  </script>
</body>
</html>
